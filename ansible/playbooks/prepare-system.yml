---
- name: Préparation du système pour Kubernetes
  hosts: k8s_cluster
  become: yes
  tasks:
    - name: Mise à jour des paquets
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600

    - name: Installation des dépendances
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - net-tools
          - vim
        state: present

    - name: Désactivation du swap
      shell: swapoff -a
      ignore_errors: yes

    - name: Désactivation swap permanent dans /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: Création du fichier de configuration des modules kernel
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: Chargement du module overlay
      modprobe:
        name: overlay
        state: present

    - name: Chargement du module br_netfilter
      modprobe:
        name: br_netfilter
        state: present

    - name: Configuration sysctl pour Kubernetes
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1

    - name: Application de la configuration sysctl
      command: sysctl --system

    - name: Affichage de fin
      debug:
        msg: "Système préparé avec succès"